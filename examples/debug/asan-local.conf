# ASan Build Configuration for OpenBMC
# Add this to your build/conf/local.conf
#
# WARNING: ASan builds have ~2x slowdown and ~2-3x memory usage
# Do not use for production images

# =============================================================================
# Option 1: Enable ASan for specific recipes (RECOMMENDED)
# =============================================================================

# Enable for phosphor-logging
CFLAGS:append:pn-phosphor-logging = " -fsanitize=address -fno-omit-frame-pointer"
CXXFLAGS:append:pn-phosphor-logging = " -fsanitize=address -fno-omit-frame-pointer"
LDFLAGS:append:pn-phosphor-logging = " -fsanitize=address"

# Enable for bmcweb (Meson-based)
EXTRA_OEMESON:append:pn-bmcweb = " -Db_sanitize=address"

# Enable for phosphor-state-manager
CFLAGS:append:pn-phosphor-state-manager = " -fsanitize=address -fno-omit-frame-pointer"
CXXFLAGS:append:pn-phosphor-state-manager = " -fsanitize=address -fno-omit-frame-pointer"
LDFLAGS:append:pn-phosphor-state-manager = " -fsanitize=address"

# Enable for entity-manager (Meson-based)
EXTRA_OEMESON:append:pn-entity-manager = " -Db_sanitize=address"

# Enable for dbus-sensors (Meson-based)
EXTRA_OEMESON:append:pn-dbus-sensors = " -Db_sanitize=address"

# =============================================================================
# Option 2: Enable ASan + UBSan together (catches more bugs)
# =============================================================================

# Combined ASan + UBSan for Meson recipes
# EXTRA_OEMESON:append:pn-bmcweb = " -Db_sanitize=address,undefined"
# EXTRA_OEMESON:append:pn-entity-manager = " -Db_sanitize=address,undefined"

# Combined for Autotools/CMake recipes
# CFLAGS:append:pn-target = " -fsanitize=address,undefined -fno-omit-frame-pointer"
# CXXFLAGS:append:pn-target = " -fsanitize=address,undefined -fno-omit-frame-pointer"
# LDFLAGS:append:pn-target = " -fsanitize=address,undefined"

# =============================================================================
# Option 3: Global ASan (use with caution - affects everything)
# =============================================================================

# WARNING: This will rebuild everything and may break some packages
# CFLAGS:append = " -fsanitize=address -fno-omit-frame-pointer"
# CXXFLAGS:append = " -fsanitize=address -fno-omit-frame-pointer"
# LDFLAGS:append = " -fsanitize=address"

# =============================================================================
# Debug symbols (required for meaningful ASan output)
# =============================================================================

# Enable debug builds
DEBUG_BUILD = "1"

# Include debug packages in image
EXTRA_IMAGE_FEATURES += "dbg-pkgs"

# Keep debug symbols
INHIBIT_PACKAGE_STRIP = "1"

# =============================================================================
# Increase image size for debug builds
# =============================================================================

# Increase rootfs size (debug symbols need more space)
IMAGE_ROOTFS_EXTRA_SPACE = "524288"

# =============================================================================
# Runtime configuration (add to target /etc/profile.d/asan.sh)
# =============================================================================

# Create ASan runtime config script
# Copy this to /etc/profile.d/asan.sh on the target:
#
# export ASAN_OPTIONS="detect_leaks=1:halt_on_error=0:log_path=/tmp/asan"
# export ASAN_OPTIONS="$ASAN_OPTIONS:symbolize=1:print_stats=1"
# export ASAN_OPTIONS="$ASAN_OPTIONS:check_initialization_order=1"
