# Kernel Debug Configuration Fragment for OpenBMC
#
# Usage:
#   1. Copy to meta-mylayer/recipes-kernel/linux/files/kernel-debug.cfg
#   2. Add to linux-aspeed_%.bbappend:
#      SRC_URI += "file://kernel-debug.cfg"
#
# WARNING: Debug options significantly increase kernel size and reduce performance
# Do not use for production builds

# =============================================================================
# Basic Debug Infrastructure
# =============================================================================

CONFIG_DEBUG_KERNEL=y
CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_INFO_DWARF4=y
CONFIG_FRAME_POINTER=y
CONFIG_STACKTRACE=y
CONFIG_KALLSYMS=y
CONFIG_KALLSYMS_ALL=y

# =============================================================================
# Early Boot Debugging
# =============================================================================

CONFIG_EARLY_PRINTK=y
CONFIG_PRINTK_TIME=y
CONFIG_DYNAMIC_DEBUG=y
CONFIG_BOOT_PRINTK_DELAY=y

# ARM-specific low-level debug (uncomment for ARM platforms)
# CONFIG_DEBUG_LL=y
# CONFIG_DEBUG_LL_UART_NONE=n
# For ASPEED AST2500/AST2600:
# CONFIG_DEBUG_UART_PHYS=0x1e784000
# CONFIG_DEBUG_UART_VIRT=0xf8784000
# CONFIG_DEBUG_UART_8250_SHIFT=2

# =============================================================================
# KASAN (Kernel AddressSanitizer)
# =============================================================================

CONFIG_KASAN=y
CONFIG_KASAN_GENERIC=y
CONFIG_KASAN_INLINE=y
CONFIG_KASAN_VMALLOC=y
CONFIG_KASAN_STACK=y
# CONFIG_KASAN_SW_TAGS is not set  # ARM64 only
# CONFIG_KASAN_HW_TAGS is not set  # ARM64 with MTE only

# =============================================================================
# Kernel UBSan
# =============================================================================

CONFIG_UBSAN=y
CONFIG_UBSAN_SANITIZE_ALL=y
CONFIG_UBSAN_BOUNDS=y
CONFIG_UBSAN_SHIFT=y
CONFIG_UBSAN_DIV_ZERO=y
CONFIG_UBSAN_UNREACHABLE=y
# CONFIG_UBSAN_ALIGNMENT is not set  # Can be noisy on ARM

# =============================================================================
# KCSAN (Kernel Concurrency Sanitizer) - Optional
# =============================================================================

# CONFIG_KCSAN=y
# CONFIG_KCSAN_STRICT=y
# CONFIG_KCSAN_WEAK_MEMORY=y
# CONFIG_KCSAN_REPORT_ONCE_IN_MS=1000

# =============================================================================
# Lock Debugging (lockdep)
# =============================================================================

CONFIG_PROVE_LOCKING=y
CONFIG_LOCK_STAT=y
CONFIG_DEBUG_LOCK_ALLOC=y
CONFIG_DEBUG_ATOMIC_SLEEP=y
CONFIG_DEBUG_MUTEXES=y
CONFIG_DEBUG_SPINLOCK=y
CONFIG_DEBUG_SPINLOCK_SLEEP=y
CONFIG_DEBUG_RT_MUTEXES=y
CONFIG_DEBUG_RWSEMS=y
CONFIG_LOCKDEP=y

# =============================================================================
# Memory Debugging
# =============================================================================

CONFIG_DEBUG_PAGEALLOC=y
CONFIG_DEBUG_PAGEALLOC_ENABLE_DEFAULT=y
CONFIG_SLUB_DEBUG=y
CONFIG_SLUB_DEBUG_ON=y
CONFIG_DEBUG_SLAB=y
CONFIG_DEBUG_OBJECTS=y
CONFIG_DEBUG_OBJECTS_FREE=y
CONFIG_DEBUG_OBJECTS_TIMERS=y
CONFIG_DEBUG_OBJECTS_WORK=y
CONFIG_DEBUG_OBJECTS_RCU_HEAD=y
CONFIG_DEBUG_OBJECTS_ENABLE_DEFAULT=1

# Stack protection
CONFIG_DEBUG_STACK_USAGE=y
CONFIG_SCHED_STACK_END_CHECK=y

# =============================================================================
# Kernel Memory Leak Detector
# =============================================================================

CONFIG_DEBUG_KMEMLEAK=y
CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=400
CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y

# =============================================================================
# Hung Task Detection
# =============================================================================

CONFIG_DETECT_HUNG_TASK=y
CONFIG_DEFAULT_HUNG_TASK_TIMEOUT=120
CONFIG_BOOTPARAM_HUNG_TASK_PANIC=y

# =============================================================================
# Soft Lockup Detection
# =============================================================================

CONFIG_SOFTLOCKUP_DETECTOR=y
CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC=y
CONFIG_DETECT_SOFT_LOCKUPS=y

# =============================================================================
# RCU Debugging
# =============================================================================

CONFIG_PROVE_RCU=y
CONFIG_DEBUG_OBJECTS_RCU_HEAD=y
CONFIG_RCU_CPU_STALL_TIMEOUT=21

# =============================================================================
# List Debugging
# =============================================================================

CONFIG_DEBUG_LIST=y
CONFIG_DEBUG_SG=y
CONFIG_DEBUG_NOTIFIERS=y

# =============================================================================
# Virtual Memory Debugging
# =============================================================================

CONFIG_DEBUG_VM=y
CONFIG_DEBUG_VM_VMACACHE=y
CONFIG_DEBUG_VM_RB=y
CONFIG_DEBUG_VM_PGFLAGS=y
CONFIG_DEBUG_VIRTUAL=y
CONFIG_DEBUG_MEMORY_INIT=y

# =============================================================================
# Scheduler Debugging
# =============================================================================

CONFIG_SCHED_DEBUG=y
CONFIG_SCHEDSTATS=y

# =============================================================================
# Tracing (ftrace)
# =============================================================================

CONFIG_FTRACE=y
CONFIG_FUNCTION_TRACER=y
CONFIG_FUNCTION_GRAPH_TRACER=y
CONFIG_IRQSOFF_TRACER=y
CONFIG_SCHED_TRACER=y
CONFIG_STACK_TRACER=y
CONFIG_DYNAMIC_FTRACE=y
CONFIG_FTRACE_SYSCALLS=y

# =============================================================================
# Kernel Debugging via Magic SysRq
# =============================================================================

CONFIG_MAGIC_SYSRQ=y
CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1

# =============================================================================
# Fault Injection (for testing error paths)
# =============================================================================

CONFIG_FAULT_INJECTION=y
CONFIG_FAILSLAB=y
CONFIG_FAIL_PAGE_ALLOC=y
CONFIG_FAIL_MAKE_REQUEST=y
CONFIG_FAIL_IO_TIMEOUT=y
CONFIG_FAULT_INJECTION_DEBUG_FS=y

# =============================================================================
# Kernel Self-Test (KUNIT)
# =============================================================================

# CONFIG_KUNIT=y
# CONFIG_KUNIT_ALL_TESTS=y

# =============================================================================
# Size Optimization (disable for debug builds)
# =============================================================================

# CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
# Use -O2 instead of -Os for better debug experience
