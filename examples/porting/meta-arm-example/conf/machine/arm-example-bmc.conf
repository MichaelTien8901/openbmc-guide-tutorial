#@TYPE: Machine
#@NAME: ARM Example BMC Platform
#@DESCRIPTION: Example OpenBMC machine configuration for ARM-based servers
#
# Reference: NVIDIA GB200 NVL BMC configuration
# https://github.com/NVIDIA/openbmc/blob/develop/meta-nvidia/meta-prime/meta-graceblackwell/meta-gb200nvl/meta-bmc/conf/machine/gb200nvl-bmc.conf

# ==============================================================================
# CPU Architecture
# ==============================================================================

# ARM64 (AArch64) configuration
# Options: cortexa53, cortexa57, cortexa72, cortexa76
DEFAULTTUNE = "cortexa53"
require conf/machine/include/arm/armv8a/tune-cortexa53.inc

# Alternative: ARM32 (uncomment if needed)
# DEFAULTTUNE = "cortexa9thf-neon"
# require conf/machine/include/arm/armv7a/tune-cortexa9.inc

# ==============================================================================
# Kernel Configuration
# ==============================================================================

# Kernel provider
PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"

# Kernel image type
# ARM64: "Image", ARM32: "zImage"
KERNEL_IMAGETYPE = "Image"

# Device tree blob
KERNEL_DEVICETREE = "arm-example-bmc.dtb"

# Optional: Additional kernel modules
MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS += "kernel-modules"

# ==============================================================================
# Bootloader Configuration
# ==============================================================================

# U-Boot provider
PREFERRED_PROVIDER_virtual/bootloader = "u-boot"
PREFERRED_PROVIDER_u-boot = "u-boot"

# U-Boot machine configuration
# Create corresponding defconfig in recipes-bsp/u-boot/
UBOOT_MACHINE = "arm_example_bmc_defconfig"

# For ARM platforms with TF-A:
# SPL_BINARY = "spl/u-boot-spl.bin"

# ==============================================================================
# Flash Layout
# ==============================================================================

# Total flash size in KB (64MB)
FLASH_SIZE = "65536"

# Partition offsets (in KB)
FLASH_UBOOT_OFFSET = "0"
FLASH_UBOOT_ENV_OFFSET = "896"
FLASH_KERNEL_OFFSET = "1024"
FLASH_ROFS_OFFSET = "10240"
FLASH_RWFS_OFFSET = "49152"

# ==============================================================================
# Console Configuration
# ==============================================================================

# Serial console device and baud rate
# ARM PL011 UART: ttyAMA0
# ASPEED UART: ttyS0-ttyS4
SERIAL_CONSOLES = "115200;ttyAMA0"

# ==============================================================================
# Machine Features
# ==============================================================================

# Hardware features
MACHINE_FEATURES = "serial"

# Optional features (uncomment as needed)
# MACHINE_FEATURES += "efi"      # EFI boot support
# MACHINE_FEATURES += "optee"    # OP-TEE support
# MACHINE_FEATURES += "pcbios"   # Legacy BIOS support

# ==============================================================================
# OpenBMC Features
# ==============================================================================

# Core BMC features
OBMC_MACHINE_FEATURES += "\
    obmc-bmc-state-mgmt \
    obmc-chassis-state-mgmt \
    obmc-host-state-mgmt \
    obmc-phosphor-fan-mgmt \
    obmc-phosphor-flash-mgmt \
"

# Optional features (uncomment as needed)
# OBMC_MACHINE_FEATURES += "obmc-phosphor-chassis-mgmt"
# OBMC_MACHINE_FEATURES += "obmc-host-ipmi"

# ==============================================================================
# Inventory Management
# ==============================================================================

# Use Entity Manager for dynamic inventory
VIRTUAL-RUNTIME_obmc-inventory-manager = "entity-manager"

# Alternative: Static inventory (legacy)
# VIRTUAL-RUNTIME_obmc-inventory-manager = "phosphor-inventory-manager"

# ==============================================================================
# Additional Packages
# ==============================================================================

# Extra packages for development
OBMC_IMAGE_EXTRA_INSTALL:append = "\
    i2c-tools \
    devmem2 \
"

# Remove packages not applicable to ARM platforms
# OBMC_IMAGE_EXTRA_INSTALL:remove = "package-name"
