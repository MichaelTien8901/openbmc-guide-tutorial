# =============================================================================
# OpenBMC Image Size Reduction Configuration
# =============================================================================
#
# Add these entries to your build/conf/local.conf to reduce image size.
# Each section is independent -- enable only what applies to your platform.
#
# Typical savings:
#   - Remove unused packages:     2-6 MB
#   - Trim kernel config:         0.5-1.5 MB
#   - Switch to musl libc:        1-2 MB
#   - Optimize compression:       1-3 MB
#   - Strip debug/docs:           0.5-1 MB
#   ----------------------------------------
#   Total potential savings:       5-13 MB
#
# WARNING: Test thoroughly after each change. Removing the wrong package
# can break boot, Redfish, IPMI, or sensor functionality.
# =============================================================================


# =============================================================================
# Section 1: Remove Unused Packages
# =============================================================================

# --- Debug and development tools (safe to remove in production) ---
IMAGE_INSTALL:remove = "packagegroup-core-tools-debug"
IMAGE_INSTALL:remove = "strace"
IMAGE_INSTALL:remove = "gdb"
IMAGE_INSTALL:remove = "gdbserver"
IMAGE_INSTALL:remove = "tcpdump"
IMAGE_INSTALL:remove = "ethtool"
IMAGE_INSTALL:remove = "ldd"
IMAGE_INSTALL:remove = "ltrace"
IMAGE_INSTALL:remove = "perf"

# --- Shell and terminal (replace bash with busybox ash) ---
# Saves ~600 KB. Ensure all scripts work with /bin/sh.
# IMAGE_INSTALL:remove = "bash"

# --- Man pages and documentation ---
IMAGE_INSTALL:remove = "man-pages"
IMAGE_INSTALL:remove = "man-db"

# --- Unused OpenBMC services ---
# Remove services your platform does not need.
# Uncomment only the lines for services you have verified are unnecessary.

# IPMI host interface (if using Redfish only)
# IMAGE_INSTALL:remove = "phosphor-ipmi-host"
# IMAGE_INSTALL:remove = "phosphor-ipmi-net"
# IMAGE_INSTALL:remove = "ipmitool"

# IPMI OEM handlers (if no OEM IPMI commands)
# IMAGE_INSTALL:remove = "phosphor-ipmi-fru"

# KVM/video (if no remote KVM)
# IMAGE_INSTALL:remove = "obmc-ikvm"
# IMAGE_INSTALL:remove = "phosphor-webui"

# Virtual media (if not needed)
# IMAGE_INSTALL:remove = "virtual-media"

# SOL console (if not needed)
# IMAGE_INSTALL:remove = "obmc-console"

# SNMP (if not needed)
# IMAGE_INSTALL:remove = "phosphor-snmp"

# LDAP (if using local auth only)
# IMAGE_INSTALL:remove = "phosphor-ldap"
# IMAGE_INSTALL:remove = "nss-pam-ldapd"

# --- Unused kernel modules ---
# These are loaded from rootfs; removing saves squashfs space.
# IMAGE_INSTALL:remove = "kernel-module-bonding"
# IMAGE_INSTALL:remove = "kernel-module-tun"
# IMAGE_INSTALL:remove = "kernel-module-veth"
# IMAGE_INSTALL:remove = "kernel-module-nft-*"


# =============================================================================
# Section 2: Kernel Configuration Trimming
# =============================================================================
#
# Create a kernel config fragment to disable unused subsystems.
# Save as meta-<vendor>/recipes-kernel/linux/linux-aspeed/size-reduce.cfg
# and add to SRC_URI in your linux-aspeed bbappend.
#
# Example fragment contents (save to .cfg file):
#
#   # Disable unused filesystems
#   # CONFIG_EXT4_FS is not set
#   # CONFIG_BTRFS_FS is not set
#   # CONFIG_XFS_FS is not set
#   # CONFIG_F2FS_FS is not set
#   # CONFIG_CIFS is not set
#   # CONFIG_NFS_FS is not set
#   # CONFIG_NFSD is not set
#
#   # Disable unused network protocols
#   # CONFIG_IPV6 is not set
#   # CONFIG_BRIDGE is not set
#   # CONFIG_NETFILTER is not set
#   # CONFIG_IP_NF_IPTABLES is not set
#   # CONFIG_BT is not set
#   # CONFIG_WIRELESS is not set
#   # CONFIG_CFG80211 is not set
#
#   # Disable unused USB support
#   # CONFIG_USB_GADGET is not set
#   # CONFIG_USB_STORAGE is not set
#   # CONFIG_USB_SERIAL is not set
#
#   # Disable unused input devices
#   # CONFIG_INPUT_KEYBOARD is not set
#   # CONFIG_INPUT_MOUSE is not set
#   # CONFIG_INPUT_TOUCHSCREEN is not set
#
#   # Disable unused media/sound/GPU
#   # CONFIG_MEDIA_SUPPORT is not set
#   # CONFIG_SOUND is not set
#   # CONFIG_DRM is not set
#
#   # Reduce kernel printk buffer
#   CONFIG_LOG_BUF_SHIFT=14
#
#   # Disable debug features
#   # CONFIG_DEBUG_INFO is not set
#   # CONFIG_FTRACE is not set
#   # CONFIG_KPROBES is not set
#   # CONFIG_PROFILING is not set

# Apply the config fragment via bbappend:
# In meta-<vendor>/recipes-kernel/linux/linux-aspeed_%.bbappend:
#
#   FILESEXTRAPATHS:prepend := "${THISDIR}/${PN}:"
#   SRC_URI += "file://size-reduce.cfg"


# =============================================================================
# Section 3: C Library Selection (musl vs glibc)
# =============================================================================
#
# musl libc is significantly smaller than glibc (~700 KB vs ~2.5 MB).
# However, some packages may not build or run correctly with musl.
# Test your full image before committing to this change.

# Switch to musl libc (saves ~1.5-2 MB)
# TCLIBC = "musl"


# =============================================================================
# Section 4: Squashfs Compression
# =============================================================================

# Use XZ compression for squashfs (best ratio, slower build)
# This is the default for most OpenBMC builds, but verify:
IMAGE_FSTYPES = "squashfs-xz"

# XZ compression options: higher dictionary = better compression, more RAM
# Default block size is 128 KB; increasing to 256 KB or 512 KB improves
# compression at the cost of decompression RAM.
EXTRA_IMAGECMD:squashfs-xz = "-comp xz -b 262144 -Xdict-size 100%"

# Alternative: LZO compression (faster boot, worse ratio)
# IMAGE_FSTYPES = "squashfs-lzo"


# =============================================================================
# Section 5: Strip and Size Optimization
# =============================================================================

# Ensure binaries are stripped (should be default, but verify)
INHIBIT_PACKAGE_STRIP = "0"

# Remove static libraries from image
IMAGE_INSTALL:remove = "packagegroup-core-tools-profile"
INHERIT += "remove-libtool"

# Remove locale data (saves ~200 KB)
IMAGE_LINGUAS = ""

# Remove Python bytecode cache (if Python is included)
ROOTFS_POSTPROCESS_COMMAND:append = " remove_pycache;"
remove_pycache() {
    find ${IMAGE_ROOTFS} -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find ${IMAGE_ROOTFS} -name "*.pyc" -delete 2>/dev/null || true
}

# Remove documentation files from rootfs
ROOTFS_POSTPROCESS_COMMAND:append = " remove_docs;"
remove_docs() {
    rm -rf ${IMAGE_ROOTFS}/usr/share/doc
    rm -rf ${IMAGE_ROOTFS}/usr/share/man
    rm -rf ${IMAGE_ROOTFS}/usr/share/info
    rm -rf ${IMAGE_ROOTFS}/usr/share/gtk-doc
}


# =============================================================================
# Section 6: Feature Flags (selectively enable/disable)
# =============================================================================
#
# OpenBMC feature flags control which packagegroups are included.
# Override in your machine .conf or local.conf:

# Disable features your platform does not use:
# OBMC_MACHINE_FEATURES:remove = "obmc-phosphor-fan-mgmt"
# OBMC_MACHINE_FEATURES:remove = "obmc-phosphor-chassis-mgmt"

# Disable bmcweb features to reduce binary size:
# EXTRA_OEMESON:pn-bmcweb = " \
#     -Dkvm=disabled \
#     -Dvm-websocket=disabled \
#     -Dredfish-bmc-journal=disabled \
#     -Dredfish-cpu-log=disabled \
#     -Dredfish-dump-log=disabled \
#     -Dredfish-host-logger=disabled \
# "


# =============================================================================
# Section 7: Image Size Limits (build-time enforcement)
# =============================================================================

# Set maximum rootfs size to catch regressions early.
# Build will fail if the rootfs exceeds this limit.
# Adjust to match your flash layout (value in KB).

# For 32 MB flash (rootfs partition = 23.75 MB = 24320 KB):
IMAGE_ROOTFS_MAXSIZE = "24320"

# For 64 MB UBI (rootfs volume = 20 MB = 20480 KB):
# IMAGE_ROOTFS_MAXSIZE = "20480"

# Extra space reserved in rootfs (set to 0 for tightest packing)
IMAGE_ROOTFS_EXTRA_SPACE = "0"
IMAGE_OVERHEAD_FACTOR = "1.0"
